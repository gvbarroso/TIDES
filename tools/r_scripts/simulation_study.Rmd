---
title: "Simulation study for TIDES"
subtitle: "Trio-based Inference of DominancE and Selection"
author: "Gustavo V. Barroso"
date: "December 1st 2020"
output:
  pdf_document: 
    toc: true
    number_sections: true
    toc_depth: 3
---

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}

library(reshape2)
library(cowplot)
library(tidyverse)
library(abc)
library(rethinking)
library(scales)
library(knitr)
library(cowplot)

knitr::opts_knit$set(root.dir = "~/Data/paper_1_first_sims/")

tolerance <- 1e-3
```

# Recessive model (h = 0.0)

## Strong selection (|s| = 0.01)

### Replicate 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_1/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_1/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_1/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_1/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_1/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_1/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_1/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_1/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_1/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1))) 
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_1/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_1/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_1/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_1/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_2/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_2/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_2/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_2/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_2/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_2/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_2/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_2/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_2/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_2/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_2/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_2/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_2/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 3

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_3/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_3/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_3/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_3/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_3/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_3/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_3/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_3/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_3/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_3/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_3/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_3/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_3/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 4

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_4/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_4/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_4/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_4/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_4/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_4/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_4/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_4/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_4/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_4/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_4/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_4/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_4/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 5

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_5/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_5/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_5/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_5/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_5/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_5/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_5/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_5/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_5/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_5/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_5/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_5/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_5/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 6

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_6/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_6/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_6/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_6/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_6/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_6/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_6/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_6/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_6/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_6/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_6/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_6/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_6/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 7

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_7/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_7/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_7/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_7/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_7/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_7/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_7/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_7/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_7/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_7/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_7/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_7/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_7/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 8

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_8/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_8/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_8/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_8/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_8/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_8/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_8/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_8/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_8/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_8/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_8/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_8/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_8/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 9

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_9/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_9/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_9/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_9/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_9/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_9/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_9/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_9/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_9/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_9/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_9/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_9/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_9/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 10

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_10/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_10/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_10/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_10/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_10/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_10/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_10/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_10/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_10/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_10/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_10/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_10/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_10/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```


## Moderate selection (|s| = 0.001)

### Replicate 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_21/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_21/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_21/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_21/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_21/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_21/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_21/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_21/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_21/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_21/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_21/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_21/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_21/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_22/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_22/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_22/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_22/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_22/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_22/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_22/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_22/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_22/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_22/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_22/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_22/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_22/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 3

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_23/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_23/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_23/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_23/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_23/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_23/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_23/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_23/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_23/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_23/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_23/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_23/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_23/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 4

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_24/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_24/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_24/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_24/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_24/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_24/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_24/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_24/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_24/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_24/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_24/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_24/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_24/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 5

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_25/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_25/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_25/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_25/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_25/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_25/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_25/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_25/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_25/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_25/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_25/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_25/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_25/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 6

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_26/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_26/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_26/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_26/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_26/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_26/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_26/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_26/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_26/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_26/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_26/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_26/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_26/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 7

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_27/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_27/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_27/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_27/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_27/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_27/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_27/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_27/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_27/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_27/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_27/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_27/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_27/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 8

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_28/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_28/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_28/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_28/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_28/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_28/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_28/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_28/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_28/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_28/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_28/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_28/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_28/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 9

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_29/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_29/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_29/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_29/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_29/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_29/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_29/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_29/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_29/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_29/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_29/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_29/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_29/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 10

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_30/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_30/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_30/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_30/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_30/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_30/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_30/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_30/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_30/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_30/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_30/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_30/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_30/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```


## Weak selection (|s| = 0.0001)

### Replicate 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_41/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_41/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_41/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_41/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_41/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_41/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_41/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_41/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_41/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_41/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_41/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_41/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_41/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_42/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_42/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_42/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_42/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_42/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_42/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_42/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_42/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_42/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_42/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_42/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_42/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_42/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 3

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_43/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_43/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_43/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_43/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_43/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_43/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_43/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_43/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_43/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_43/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_43/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_43/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_43/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 4

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_44/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_44/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_44/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_44/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_44/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_44/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_44/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_44/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_44/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_44/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_44/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_44/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_44/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 5

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_45/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_45/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_45/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_45/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_45/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_45/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_45/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_45/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_45/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_45/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_45/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_45/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_45/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 6

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_46/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_46/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_46/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_46/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_46/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_46/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_46/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_46/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_46/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_46/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_46/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_46/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_46/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 7

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_47/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_47/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_47/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_47/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_47/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_47/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_47/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_47/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_47/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_47/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_47/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_47/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_47/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 8

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_48/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_48/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_48/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_48/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_48/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_48/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_48/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_48/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_48/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_48/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_48/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_48/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_48/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 9

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_49/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_49/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_49/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_49/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_49/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_49/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_49/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_49/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_49/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_49/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_49/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_49/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_49/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 10

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_50/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_50/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_50/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_50/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_50/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_50/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_50/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_50/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_50/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_50/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_50/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_50/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_50/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```



# Additive model (h = 0.5)

## Strong selection (|s| = 0.01)

### Replicate 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_11/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_11/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_11/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_11/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_11/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_11/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_11/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_11/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_11/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_11/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_11/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_11/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_11/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_12/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_12/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_12/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_12/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_12/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_12/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_12/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_12/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_12/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_12/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_12/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_12/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_12/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 3

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_13/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_13/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_13/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_13/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_13/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_13/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_13/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_13/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_13/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_13/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_13/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_13/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_13/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 4

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_14/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_14/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_14/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_14/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_14/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_14/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_14/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_14/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_14/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_14/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_14/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_14/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_14/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 5

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_15/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_15/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_15/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_15/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_15/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_15/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_15/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_15/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_15/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_15/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_15/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_15/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_15/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 6

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_16/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_16/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_16/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_16/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_16/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_16/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_16/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_16/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_16/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_16/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_16/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_16/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_16/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 7

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_17/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_17/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_17/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_17/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_17/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_17/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_17/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_17/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_17/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_17/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_17/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_17/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_17/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 8

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_18/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_18/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_18/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_18/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_18/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_18/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_18/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_18/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_18/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_18/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_18/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_18/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_18/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 9

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_19/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_19/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_19/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_19/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_19/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_19/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_19/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_19/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_19/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_19/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_19/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_19/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_19/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 10

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_20/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_20/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_20/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_20/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_20/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_20/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_20/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_20/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_20/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_20/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_20/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.01

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_20/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_20/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```


## Moderate selection (|s| = 0.001)

### Replicate 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_31/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_31/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_31/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_31/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_31/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_31/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_31/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_31/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_31/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_31/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_31/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_31/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_31/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_32/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_32/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_32/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_32/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_32/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_32/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_32/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_32/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_32/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_32/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_32/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_32/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_32/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 3

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_33/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_33/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_33/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_33/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_33/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_33/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_33/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_33/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_33/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_33/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_33/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_33/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_33/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 4

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_34/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_34/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_34/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_34/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_34/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_34/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_34/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_34/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_34/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_34/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_34/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_34/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_34/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 5

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_35/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_35/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_35/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_35/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_35/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_35/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_35/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_35/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_35/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_35/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_35/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_35/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_35/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 6

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_36/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_36/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_36/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_36/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_36/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_36/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_36/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_36/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_36/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_36/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_36/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_36/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_36/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 7

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_37/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_37/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_37/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_37/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_37/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_37/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_37/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_37/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_37/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_37/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_37/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_37/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_37/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 8

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_38/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_38/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_38/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_38/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_38/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_38/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_38/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_38/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_38/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_38/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_38/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_38/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_38/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 9

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_39/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_39/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_39/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_39/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_39/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_39/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_39/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_39/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_39/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_39/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_39/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_39/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_39/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 10

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_40/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_40/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_40/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_40/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_40/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_40/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_40/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_40/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_40/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_40/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_40/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_40/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_40/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```


## Weak selection (|s| = 0.0001)

### Replicate 1

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_51/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_51/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_51/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_51/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_51/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_51/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_51/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_51/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_51/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_51/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_51/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_51/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_51/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 2

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_52/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_52/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_52/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_52/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_52/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_52/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_52/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_52/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_52/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_52/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_52/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_52/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_52/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 3

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_53/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_53/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_53/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_53/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_53/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_53/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_53/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_53/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_53/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_53/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_53/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_53/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_53/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 4

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_54/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_54/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_54/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_54/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_54/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_54/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_54/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_54/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_54/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_54/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_54/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_54/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_54/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 5

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_55/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_55/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_55/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_55/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_55/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_55/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_55/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_55/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_55/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_55/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_55/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_55/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_55/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 6

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_56/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_56/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_56/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_56/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_56/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_56/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_56/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_56/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_56/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_56/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_56/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_56/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_56/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 7

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_57/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_57/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_57/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_57/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_57/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_57/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_57/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_57/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_57/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_57/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_57/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_57/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_57/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 8

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_58/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_58/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_58/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_58/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_58/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_58/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_58/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_58/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_58/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_58/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_58/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_58/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_58/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 9

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_59/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_59/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_59/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_59/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_59/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_59/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_59/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_59/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_59/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_59/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_59/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_59/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_59/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```

### Replicate 10

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# observed summary statistics are the same for all models, we arbitrarily pick one:
obs_sum_stats <- read.table("script_60/full_model/obs_sum_stats.txt", header = T)

# summary statistics under each model
sim_sum_stats_additive <- read.table(gzfile("script_60/additive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_recessive <- read.table(gzfile("script_60/recessive_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_neutral <- read.table(gzfile("script_60/neutral_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_full <- read.table(gzfile("script_60/full_model/sum_stats_dist.gz"), header = T)
sim_sum_stats_models <- rbind.data.frame(sim_sum_stats_additive, 
                                         sim_sum_stats_recessive, 
                                         sim_sum_stats_neutral,
                                         sim_sum_stats_full)

# parameter draws under each model
sim_params_additive <- read.table(gzfile("script_60/additive_model/sim_params_dist.gz"), header = T)
sim_params_recessive <- read.table(gzfile("script_60/recessive_model/sim_params_dist.gz"), header = T)
sim_params_neutral <- read.table(gzfile("script_60/neutral_model/sim_params_dist.gz"), header = T)
sim_params_full <- read.table(gzfile("script_60/full_model/sim_params_dist.gz"), header = T)
sim_params_models <- rbind.data.frame(sim_params_additive, sim_params_recessive, sim_params_neutral, sim_params_full)

nsims <- nrow(sim_sum_stats_full)

# model indicators
models <- c(rep("additive", nsims), rep("recessive", nsims), rep("neutral", nsims), rep("full", nsims))
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 2D
sum_stats_2d <- cbind.data.frame(sim_sum_stats_models[models != "full",], models[models != "full"])
sum_stats_2d_ds <- sample_n(sum_stats_2d, 6e+4) # downsample otherwise plot is too big
names(sum_stats_2d_ds)[3] <- "models"

ss2d <- ggplot(data = sum_stats_2d_ds, aes(x = diff_het, y = diff_homo, color = models))
ss2d <- ss2d + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
ss2d <- ss2d + labs(title = NULL, x = "delta_het", y = "delta_homo")
ss2d <- ss2d + scale_color_manual(values = c("#7fc97f", "#beaed4", "#fdc086"))
ss2d <- ss2d + guides(colour = guide_legend(override.aes = list(alpha = 1)))
ss2d <- ss2d + theme(axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     axis.title.x = element_text(size = 20),
                     axis.title.y = element_text(size = 20))
ss2d <- ss2d + geom_point(x = obs_sum_stats$diff_het, y = obs_sum_stats$diff_homo, col = 'red', shape = 8, size = 6)
ss2d
```



```{r, include=FALSE}

fixed_models <- models[models != "full"] # excludes full model
sim_sum_stats_fixed_models <- sim_sum_stats_models[models %in% fixed_models,]

mod_sel <- invisible(postpr(target = obs_sum_stats, index = fixed_models, sumstat = sim_sum_stats_fixed_models, method = "neuralnet", tol = tolerance))
summary(mod_sel)

write.table(mod_sel$pred, "script_60/models_post_probs.txt", col.names = F, row.names = F, quote = F, sep = "\t") # for plotting later on
```

```{r, echo=FALSE, results='asis'}
mpp <- read.table("script_60/models_post_probs.txt", sep = "\t", header = F)
names(mpp) <- c("Model", "Posterior Probability")
kable(mpp)

```



```{r, echo=FALSE, message=FALSE, warning=FALSE}

sim_h <- 0.5
sim_s <- 0.0001

model <- "full" # in most cases we are interested in the full model (with least assumption)

res_reject <- abc(target = obs_sum_stats,
                  param = sim_params_models[models == model,],
                  sumstat = sim_sum_stats_models[models == model,],
                  tol = tolerance,
                  method = "rejection")

res_neuralnet <- invisible(abc(target = obs_sum_stats,
                               param = sim_params_models[models == model,],
                               sumstat = sim_sum_stats_models[models == model,],
                               kernel = "epanechnikov", 
                               tol = tolerance, method = "neuralnet",
                               numnet = 6, transf = "log"))

samp_size <- nsims * tolerance
prior_h <- runif(samp_size, 0, 0.6) # same as h_interval in TIDES's options file
prior_s <- 10^(-runif(samp_size, 1, 6)) # same as s_interval in TIDES's options file

dat <- cbind.data.frame(res_neuralnet$adj.values, res_reject$unadj.values, prior_h, prior_s)
names(dat) <- c("neuralnet_h", "neuralnet_s", "rejection_h", "rejection_s", "prior_h", "prior_s")

# writes posterior distributions to files
write.table(dat$neuralnet_h, "script_60/posterior_dist_h.txt", quote = F, col.names = F, row.names = F, sep = "\n")
write.table(dat$neuralnet_s, "script_60/posterior_dist_s.txt", quote = F, col.names = F, row.names = F, sep = "\n")

# s density
dat_s <- dplyr::select(dat, ends_with("_s")) 
dat_s$sim <- 1:nrow(dat_s)
molten_vals <- melt(dat_s, id.vars = "sim")

dens_plot_s <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_s <- dens_plot_s + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_s <- dens_plot_s + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_s <- dens_plot_s + geom_vline(aes(xintercept = sim_s), linetype = "dashed", color = "black", size = 0.85)
dens_plot_s <- dens_plot_s + labs(title = NULL, x = "|s|", y = NULL) 
dens_plot_s <- dens_plot_s + scale_x_log10()
dens_plot_s <- dens_plot_s + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18),
                                   axis.title.y = element_text(size = 16))

# h density
dat_h <- dplyr::select(dat, ends_with("_h")) 
dat_h$sim <- 1:nrow(dat_h)
molten_vals <- melt(dat_h, id.vars = "sim")

dens_plot_h <- ggplot(molten_vals, aes(x = value, color = variable))
dens_plot_h <- dens_plot_h + stat_density(geom = "line", size = 1.125) + theme_bw() 
dens_plot_h <- dens_plot_h + scale_color_manual(values = c("red", "darkcyan", "grey"))
dens_plot_h <- dens_plot_h + geom_vline(aes(xintercept = sim_h), linetype = "dashed", color = "black", size = 1)
dens_plot_h <- dens_plot_h + labs(title = NULL, x = "h", y = NULL) 
dens_plot_h <- dens_plot_h + theme(text = element_text(size = 14), 
                                   legend.position = "none",
                                   legend.title = element_blank(),
                                   axis.title.x = element_text(size = 18), 
                                   axis.title.y = element_text(size = 16))

s_hpdi <- HPDI(dat$neuralnet_s, prob = 0.95)
h_hpdi <- HPDI(dat$neuralnet_h, prob = 0.95)

post_scatter <- ggplot(data = dat, aes(y = neuralnet_s, x = neuralnet_h))
post_scatter <- post_scatter + geom_point(shape = 16, size = 2,  alpha = 0.15) + theme_bw()
post_scatter <- post_scatter + labs(title = NULL, x = "h", y = "|s|")
post_scatter <- post_scatter + theme(axis.text.x = element_text(size = 14),
                                     axis.text.y = element_text(size = 14),
                                     axis.title.x = element_text(size = 24),
                                     axis.title.y = element_text(size = 24))
post_scatter <- post_scatter + geom_vline(aes(xintercept = sim_h), color = "blue")
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[1]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_vline(aes(xintercept = h_hpdi[2]), color = "blue", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = sim_s), color = "red")
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[1]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_hline(aes(yintercept = s_hpdi[2]), color = "red", linetype = "dashed", size = 0.5)
post_scatter <- post_scatter + geom_density2d(colour = "green")
post_scatter <- post_scatter + scale_x_continuous(breaks = pretty_breaks())
post_scatter <- post_scatter + scale_y_log10(breaks = pretty_breaks())

dens_plot <- plot_grid(dens_plot_s, dens_plot_h, ncol = 2)
plot_grid(dens_plot, post_scatter, ncol = 1, rel_heights = c(1, 2))
```
